@page "/application-success/{id:int}"
@using FastCreditApp.Data
@using FastCreditApp.Data.Entities
@using Microsoft.AspNetCore.Components
@using Microsoft.EntityFrameworkCore
@inject FastCreditDbContext Db
@inject NavigationManager Nav

<h3>✅ Заявката е изпратена успешно</h3>

@if (IsLoaded && Credit != null)
{
    <div class="alert alert-success">
        Вашата кандидатура беше подадена успешно. Ето информацията, която изпратихте:
    </div>

    <fieldset class="border p-3 mb-3">
        <legend>Лични данни</legend>
        <p><strong>Име:</strong> @Client?.FirstName @Client?.MiddleName @Client?.LastName</p>
        <p><strong>ЕГН:</strong> @Client?.EGN</p>
        <p><strong>Email:</strong> @Client?.Email</p>
        <p><strong>Телефон:</strong> @Client?.PhoneNumber</p>
        <p><strong>ЛК:</strong> @Client?.IDCardNumber (@Client?.IDIssuer)</p>
        <p><strong>Издадена на:</strong> @Client?.IDIssueDate.ToShortDateString()</p>
        <p><strong>Валидна до:</strong> @Client?.IDValidityDate.ToShortDateString()</p>
    </fieldset>

    <fieldset class="border p-3 mb-3">
        <legend>Адрес</legend>
        <p><strong>Град:</strong> @Address?.City</p>
        <p><strong>Улица/Квартал:</strong> @Address?.StreetNeighbourhood</p>
        <p><strong>№:</strong> @Address?.Number</p>
        <p><strong>Пощенски код:</strong> @Address?.PostCode</p>
    </fieldset>

    <fieldset class="border p-3 mb-3">
        <legend>Финансови данни</legend>
        <p><strong>Месечен доход:</strong> @Financial?.MontlyIncome лв.</p>
        <p><strong>Месечни разходи:</strong> @Financial?.MontlyExpenses лв.</p>
        <p><strong>Тип заетост:</strong> @EmploymentTypeText</p>
    </fieldset>

    <fieldset class="border p-3 mb-3">
        <legend>Кредит</legend>
        <p><strong>Сума:</strong> @Credit.CreditAmount лв.</p>
        <p><strong>Лихвен процент:</strong> @Credit.InterestRate %</p>
        <p><strong>Начална дата:</strong> @Credit.CreditBeginDate?.ToShortDateString()</p>
        <p><strong>Крайна дата:</strong> @Credit.CreditEndDate?.ToShortDateString()</p>
        <p><strong>Статус:</strong> Очакващ решение</p>
    </fieldset>

    @* <button class="btn btn-secondary" @onclick="() => Nav.NavigateTo("")">Обратно към начална страница</button> *@
}
else if (!IsLoaded)
{
    <p>Зареждане на данните…</p>
}
else
{
    <div class="alert alert-danger">
        Няма открита кандидатура с този номер.
    </div>
}

@code {
    [Parameter] public int id { get; set; }

    public Credit Credit { get; set; }
    public Client Client { get; set; }
    public ClientAddress Address { get; set; }
    public ClientFinancial Financial { get; set; }
    public string EmploymentTypeText { get; set; } = "(неизвестно)";
    public bool IsLoaded { get; set; } = false;

    protected override async Task OnInitializedAsync()
    {
        Credit = await Db.Credits
            .Include(c => c.Client)
            .FirstOrDefaultAsync(c => c.ID == id);

        if (Credit != null)
        {
            var clientId = Credit.ClientID;

            Client = Credit.Client;

            Address = await Db.ClientAddresses
                .FirstOrDefaultAsync(a => a.ClientID == clientId);

            Financial = await Db.ClientFinancials
                .FirstOrDefaultAsync(f => f.ClientID == clientId);

            if (Financial != null)
            {
                var employment = await Db.Nomenclature
                    .FirstOrDefaultAsync(n => n.NomCode == Financial.EmploymentType);

                EmploymentTypeText = employment?.Description ?? "(неизвестно)";
            }
        }

        IsLoaded = true;
    }
}
